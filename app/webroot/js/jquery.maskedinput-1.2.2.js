(function(t){var e=(t.browser.msie?"paste":"input")+".mask",i=window.orientation!=void 0;t.mask={definitions:{9:"[0-9]",a:"[A-Za-z]","*":"[A-Za-z0-9]"}},t.fn.extend({caret:function(t,e){if(this.length!=0){if("number"==typeof t)return e="number"==typeof e?e:t,this.each(function(){if(this.setSelectionRange)this.focus(),this.setSelectionRange(t,e);else if(this.createTextRange){var i=this.createTextRange();i.collapse(!0),i.moveEnd("character",e),i.moveStart("character",t),i.select()}});if(this[0].setSelectionRange)t=this[0].selectionStart,e=this[0].selectionEnd;else if(document.selection&&document.selection.createRange){var i=document.selection.createRange();t=0-i.duplicate().moveStart("character",-1e5),e=t+i.text.length}return{begin:t,end:e}}},unmask:function(){return this.trigger("unmask")},mask:function(n,s){if(!n&&this.length>0){var o=t(this[0]),a=o.data("tests");return t.map(o.data("buffer"),function(t,e){return a[e]?t:null}).join("")}s=t.extend({placeholder:"_",completed:null},s);var r=t.mask.definitions,a=[],l=n.length,h=null,c=n.length;return t.each(n.split(""),function(t,e){"?"==e?(c--,l=t):r[e]?(a.push(new RegExp(r[e])),null==h&&(h=a.length-1)):a.push(null)}),this.each(function(){function o(t){for(;++t<=c&&!a[t];);return t}function u(t){for(;!a[t]&&--t>=0;);for(var e=t;c>e;e++)if(a[e]){b[e]=s.placeholder;var i=o(e);if(!(c>i&&a[e].test(b[i])))break;b[e]=b[i]}g(),_.caret(Math.max(h,t))}function d(t){for(var e=t,i=s.placeholder;c>e;e++)if(a[e]){var n=o(e),r=b[e];if(b[e]=i,!(c>n&&a[n].test(r)))break;i=r}}function p(e){var n=t(this).caret(),s=e.keyCode;return y=16>s||s>16&&32>s||s>32&&41>s,n.begin-n.end==0||y&&8!=s&&46!=s||m(n.begin,n.end),8==s||46==s||i&&127==s?(u(n.begin+(46==s?0:-1)),!1):27==s?(_.val(w),_.caret(0,v()),!1):void 0}function f(e){if(y)return y=!1,e.keyCode==8?!1:null;e=e||window.event;var i=e.charCode||e.keyCode||e.which,n=t(this).caret();if(e.ctrlKey||e.altKey||e.metaKey)return!0;if(i>=32&&125>=i||i>186){var r=o(n.begin-1);if(c>r){var l=String.fromCharCode(i);if(a[r].test(l)){d(r),b[r]=l,g();var h=o(r);t(this).caret(h),s.completed&&h==c&&s.completed.call(_)}}}return!1}function m(t,e){for(var i=t;e>i&&c>i;i++)a[i]&&(b[i]=s.placeholder)}function g(){return _.val(b.join("")).val()}function v(t){for(var e=_.val(),i=-1,n=0,o=0;c>n;n++)if(a[n]){for(b[n]=s.placeholder;o++<e.length;){var r=e.charAt(o-1);if(a[n].test(r)){b[n]=r,i=n;break}}if(o>e.length)break}else b[n]==e[o]&&n!=l&&(o++,i=n);return!t&&l>i+1?(_.val(""),m(0,c)):(t||i+1>=l)&&(g(),t||_.val(_.val().substring(0,i+1))),l?n:h}var _=t(this),b=t.map(n.split(""),function(t){return"?"!=t?r[t]?s.placeholder:t:void 0}),y=!1,w=_.val();_.data("buffer",b).data("tests",a),_.attr("readonly")||_.one("unmask",function(){_.unbind(".mask").removeData("buffer").removeData("tests")}).bind("focus.mask",function(){w=_.val();var t=v();g(),setTimeout(function(){t==n.length?_.caret(0,t):_.caret(t)},0)}).bind("blur.mask",function(){v(),_.val()!=w&&_.change()}).bind("keydown.mask",p).bind("keypress.mask",f).bind(e,function(){setTimeout(function(){_.caret(v(!0))},0)}),v()})}})})(jQuery);